name: Build

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  Build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      #################### BUILD ####################
      - name: Make Static Files
        run: make

      #################### MINIFY ####################
      - run: npm install clean-css-cli -g
      - run: npm install uglify-js -g
      - run: npm install html-minifier -g

      - name: Minify CSS
        run: |
          find ./docs/ -type f -name "*.css" -not -path "*/node_modules/*" -exec cleancss -o {} {} \;

      - name: Minify JS
        run: |
          find ./docs/ -type f -name "*.js" -not -path "*/node_modules/*" -exec uglifyjs {} -o {} \;

      - name: Minify HTML
        run: |
          find ./docs/ -type f -name "*.html" -not -path "*/node_modules/*" -exec html-minifier {} -o {} \
            --collapse-whitespace --html5 --remove-comments --minify-css --minify-js \;

      #################### VALIDATE ####################
      - name: W3 Validate HTML
        uses: anishathalye/proof-html@v2
        with:
          directory: ./docs/
          enforce_https: false
          disable_external: true

      #################### PUSH ####################
      - name: "Push Changes"
        if: github.event_name == 'push'
        run: |
          git config user.name "Travis Heavener"
          git config user.email "travis.heavener@gmail.com"
          
          # Patch .gitignore
          sed -i '/^[[:space:]]*docs\/\*[[:space:]]*$/d' .gitignore
          git add .gitignore
          git commit -m "Automated .gitignore update for ${{ github.sha }}"

          # Push remaining changes
          git commit -am "Automated minification of ${{ github.sha }}"
          git push --force -u origin main:gh-pages